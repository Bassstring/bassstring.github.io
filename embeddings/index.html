<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2D/3D Word Embeddings</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.18.2/plotly.min.js"></script>
  <!-- loads a local word2vec js object -->
  <script type="text/javascript" src="./word_vectors_15k.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      max-width: 100%;
      overflow-x: hidden;
    }

    #chart-container {
      width: 100%;
      max-width: 800px;
      height: 60vh;
      min-height: 300px;
    }

    input,
    button {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      max-width: 300px;
      font-size: 16px;
    }

    #loading {
      font-weight: bold;
      color: #007bff;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }

    .toggle-label {
      margin: 0 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";

      .slider:before {
        position: absolute;
        content: "";
        height: 24px;
        width: 24px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
    }

    input:checked+.slider {
      background-color: #2196F3;
    }

    input:checked+.slider:before {
      transform: translateX(30px);
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      h1 {
        font-size: 24px;
      }

      #chart-container {
        height: 50vh;
      }
    }
  </style>
</head>

<body>
  <h1>2D/3D Word Embeddings</h1>
  <div id="loading">Loading model...</div>
  <div id="chart-container" style="display: none;"></div>
  <input type="text" id="wordInput" placeholder="Enter a word" disabled>
  <button onclick="addWord()" disabled>Add Word</button>
  <div class="toggle-container">
    <span class="toggle-label">2D</span>
    <label class="switch">
      <input type="checkbox" id="viewToggle" onchange="toggleView()">
      <span class="slider"></span>
    </label>
    <span class="toggle-label">3D</span>
  </div>

  <script>
    let model;
    let embeddings = [];
    const words = ['katze', 'hund', 'fisch', 'vogel', 'baum'];
    let is3DView = false;

    async function loadModel() {
      // document.querySelector('button').disabled = false;
      // document.getElementById('viewToggle').disabled = false;
      await updateEmbeddings();
      document.querySelector('button').disabled = false;
      document.getElementById('wordInput').disabled = false;
      document.getElementById('viewToggle').disabled = false;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('chart-container').style.display = 'block';
    }

    async function getEmbeddings(words) {
      const embeddings = words.map(word => tf.tensor(word2vec[word]));
      return tf.stack(embeddings).arraySync()
    }

    function pca(data, k) {
      const dataTransposed = tf.transpose(data);
      const [q, r] = tf.linalg.qr(dataTransposed);
      const eigenVectors = q.slice([0, 0], [-1, k]);
      return tf.matMul(data, eigenVectors).arraySync();
    }

    async function updateEmbeddings() {
      const embeddingsTensor = await getEmbeddings(words);
      const reducedEmbeddings = pca(embeddingsTensor, 3);
      embeddings = words.map((word, i) => ({
        word,
        embedding: reducedEmbeddings[i]
      }));
      updateChart();
    }

    function updateChart() {
      const data = is3DView ? prepare3DData() : prepare2DData();
      const layout = is3DView ? prepare3DLayout() : prepare2DLayout();
      Plotly.newPlot('chart-container', data, layout);
    }

    function prepare2DData() {
      return [{
        x: embeddings.map(e => e.embedding[0]),
        y: embeddings.map(e => e.embedding[1]),
        text: words,
        mode: 'markers+text',
        type: 'scatter',
        marker: {
          size: 10,
          color: embeddings.map((_, i) => i),
          colorscale: 'Viridis'
        },
        textposition: 'top center'
      }];
    }

    function prepare3DData() {
      return [{
        x: embeddings.map(e => e.embedding[0]),
        y: embeddings.map(e => e.embedding[1]),
        z: embeddings.map(e => e.embedding[2]),
        text: words,
        mode: 'markers+text',
        type: 'scatter3d',
        marker: {
          size: 5,
          color: embeddings.map((_, i) => i),
          colorscale: 'Viridis'
        },
        textposition: 'top center'
      }];
    }

    function prepare2DLayout() {
      return {
        title: '2D Word Embeddings',
        xaxis: {title: 'X'},
        yaxis: {title: 'Y'},
        margin: {l: 30, r: 30, b: 30, t: 30},
        autosize: true,
        responsive: true
      };
    }
    function prepare3DLayout() {
      return {
        title: '3D Word Embeddings',
        scene: {
          xaxis: {title: 'X'},
          yaxis: {title: 'Y'},
          zaxis: {title: 'Z'}
        },
        margin: {l: 0, r: 0, b: 0, t: 40},
        autosize: true,
        responsive: true
      };
    }

    async function addWord() {
      const newWord = document.getElementById('wordInput').value.trim().toLowerCase();
      if (!word2vec.hasOwnProperty(newWord)) {
        alert(newWord + " ist leider nicht in diesem Datensatz enthalten")
        return;
      }
      if (newWord && !words.includes(newWord)) {
        words.push(newWord);
        await updateEmbeddings();
        document.getElementById('wordInput').value = '';
      }
    }

    function toggleView() {
      is3DView = document.getElementById('viewToggle').checked;
      updateChart();
    }

    loadModel();
  </script>
</body>

</html>
